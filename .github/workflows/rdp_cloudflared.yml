name: RDP via Cloudflare Tunnel

on:
  workflow_dispatch:

jobs:
  rdp-cloudflared:
    runs-on: windows-latest
    timeout-minutes: 360  # 6 hours max
    permissions:
      contents: read
    
    steps:
      - name: Security Notice
        shell: pwsh
        run: |
          Write-Host "‚ö†Ô∏è  SECURITY NOTICE" -ForegroundColor Red
          Write-Host "This workflow requires a secret to be configured:" -ForegroundColor Yellow
          Write-Host "  - PASSWORD: RDP password for the runneradmin user" -ForegroundColor Yellow
          Write-Host "" 
          Write-Host "RDP credentials will be displayed in workflow logs." -ForegroundColor Yellow
          Write-Host "Do NOT use this with sensitive data or production systems." -ForegroundColor Yellow
          Write-Host ""
          Write-Host "‚ÑπÔ∏è  This workflow uses Cloudflare Tunnel (cloudflared)" -ForegroundColor Cyan
          Write-Host "No Cloudflare account or authentication required!" -ForegroundColor Cyan
          Write-Host ""
      
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Download cloudflared
        shell: pwsh
        run: |
          Write-Host "üì• Downloading cloudflared..." -ForegroundColor Cyan
          Invoke-WebRequest https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-windows-amd64.exe -OutFile cloudflared.exe
          Write-Host "‚úÖ Download complete" -ForegroundColor Green
      
      - name: Enable Remote Desktop
        shell: pwsh
        run: |
          Write-Host "üîß Enabling Remote Desktop..." -ForegroundColor Cyan
          
          # Enable Remote Desktop
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0
          
          # Enable RDP through Windows Firewall
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
          
          # Enable Network Level Authentication
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 1
          
          Write-Host "‚úÖ Remote Desktop enabled successfully" -ForegroundColor Green
      
      - name: Configure RDP User
        shell: pwsh
        env:
          RDP_PASSWORD: ${{ secrets.PASSWORD }}
        run: |
          Write-Host "üë§ Configuring RDP user..." -ForegroundColor Cyan

          # Validate password is provided
          if (-not $env:RDP_PASSWORD) {
            Write-Host "‚ùå ERROR: PASSWORD secret is not configured!" -ForegroundColor Red
            Write-Host "" -ForegroundColor Red
            Write-Host "Please configure the PASSWORD secret in your repository:" -ForegroundColor Yellow
            Write-Host "  1. Go to Settings > Secrets and variables > Actions" -ForegroundColor White
            Write-Host "  2. Click 'New repository secret'" -ForegroundColor White
            Write-Host "  3. Name: PASSWORD" -ForegroundColor White
            Write-Host "  4. Value: Your desired RDP password (must meet complexity requirements)" -ForegroundColor White
            Write-Host "" -ForegroundColor Yellow
            exit 1
          }

          # Validate password length (Windows requires at least 6 characters typically)
          if ($env:RDP_PASSWORD.Length -lt 6) {
            Write-Host "‚ùå ERROR: PASSWORD is too short (minimum 6 characters required)" -ForegroundColor Red
            exit 1
          }

          # Set password for the existing runneradmin user
          try {
            $securePassword = ConvertTo-SecureString -AsPlainText $env:RDP_PASSWORD -Force
            Set-LocalUser -Name "runneradmin" -Password $securePassword -ErrorAction Stop
            Write-Host "‚úÖ User configured successfully" -ForegroundColor Green
          } catch {
            Write-Host "‚ùå ERROR: Failed to set password: $($_.Exception.Message)" -ForegroundColor Red
            Write-Host "" -ForegroundColor Yellow
            Write-Host "Password may not meet Windows complexity requirements:" -ForegroundColor Yellow
            Write-Host "  - At least 8 characters recommended" -ForegroundColor White
            Write-Host "  - Mix of uppercase, lowercase, numbers, and symbols" -ForegroundColor White
            Write-Host "  - Example: MyP@ssw0rd!" -ForegroundColor White
            Write-Host "" -ForegroundColor Yellow
            exit 1
          }

          Write-Host ""
          Write-Host "Username: runneradmin" -ForegroundColor White
          Write-Host "Password: (configured from secrets)" -ForegroundColor White
      
      - name: Start Cloudflare Tunnel
        shell: pwsh
        run: |
          Write-Host "üöá Starting Cloudflare tunnel..." -ForegroundColor Cyan
          
          # Start cloudflared in the background and redirect output to file
          # Use tcp:// protocol for RDP tunneling (not rdp:// which isn't a valid scheme)
          Start-Process -FilePath ".\cloudflared.exe" -ArgumentList "tunnel --url tcp://localhost:3389" -RedirectStandardError "C:\cloudflared.txt"
          
          # Wait for tunnel to initialize
          Write-Host "Waiting for tunnel to initialize..." -ForegroundColor Yellow
          Start-Sleep -Seconds 10
          
          # Extract the tunnel URL from the output
          $tunnelUrl = ""
          $urlPattern = 'https://[a-zA-Z0-9\-]+\.trycloudflare\.com'
          
          Get-Content C:\cloudflared.txt | ForEach-Object {
            $match = Select-String -Pattern $urlPattern -InputObject $_
            if ($match) {
              $tunnelUrl = $match.Matches.Value
              if ($tunnelUrl) {
                # Remove https:// prefix for display
                $cleanUrl = $tunnelUrl -replace "https://", ""
                
                Write-Host ""
                Write-Host "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê" -ForegroundColor Green
                Write-Host "    üéâ RDP CONNECTION READY!" -ForegroundColor Green
                Write-Host "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê" -ForegroundColor Green
                Write-Host ""
                Write-Host "üåê Tunnel URL: $cleanUrl" -ForegroundColor Cyan
                Write-Host "üë§ Username: runneradmin" -ForegroundColor Cyan
                Write-Host "üîë Password: (your PASSWORD secret)" -ForegroundColor Cyan
                Write-Host ""
                Write-Host "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê" -ForegroundColor Green
                Write-Host ""
                Write-Host "üìù How to connect:" -ForegroundColor Yellow
                Write-Host "  1. Download cloudflared: https://github.com/cloudflare/cloudflared/releases/latest" -ForegroundColor White
                Write-Host "  2. Run on your local machine:" -ForegroundColor White
                Write-Host "     cloudflared access tcp --hostname $cleanUrl --url localhost:13389" -ForegroundColor Cyan
                Write-Host "  3. Open Remote Desktop Connection (mstsc.exe)" -ForegroundColor White
                Write-Host "  4. Connect to: localhost:13389" -ForegroundColor White
                Write-Host "  5. Login with username 'runneradmin' and your password" -ForegroundColor White
                Write-Host ""
                Write-Host "üí° Note: Port 13389 on localhost is just an example, use any available port" -ForegroundColor Yellow
                Write-Host ""
                
                # Save to environment for job summary
                "TUNNEL_URL=$cleanUrl" | Out-File -FilePath $env:GITHUB_ENV -Append
                "TUNNEL_FULL_URL=$tunnelUrl" | Out-File -FilePath $env:GITHUB_ENV -Append
              }
            }
          }
          
          if (-not $tunnelUrl) {
            Write-Host "‚ùå Failed to extract tunnel URL" -ForegroundColor Red
            Write-Host "Cloudflared output:" -ForegroundColor Yellow
            Get-Content C:\cloudflared.txt
            exit 1
          }
      
      - name: Generate Job Summary
        shell: pwsh
        run: |
          $summary = @"
          # üñ•Ô∏è RDP Connection Ready via Cloudflare Tunnel
          
          ## Connection Information
          
          | Parameter | Value |
          |-----------|-------|
          | **Tunnel URL** | ``$env:TUNNEL_URL`` |
          | **Username** | ``runneradmin`` |
          | **Password** | ``(your PASSWORD secret)`` |
          
          ## üîå How to Connect
          
          ### Step 1: Download cloudflared
          Download cloudflared for your operating system:
          - **Windows**: [cloudflared-windows-amd64.exe](https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-windows-amd64.exe)
          - **macOS**: ``brew install cloudflared``
          - **Linux**: [See releases](https://github.com/cloudflare/cloudflared/releases/latest)
          
          ### Step 2: Create local tunnel
          Open a terminal/command prompt and run:
          ``````
          cloudflared access tcp --hostname $env:TUNNEL_URL --url localhost:13389
          ``````
          
          > üí° You can use any available local port instead of 13389
          
          ### Step 3: Connect via RDP
          1. Open **Remote Desktop Connection** (mstsc.exe on Windows)
          2. Connect to: ``localhost:13389`` (or your chosen port)
          3. Login with:
             - Username: ``runneradmin``
             - Password: ``(your PASSWORD secret)``
          
          ## ‚úÖ Features
          
          - **Cloudflare Tunnel** - Enterprise-grade infrastructure
          - **Better performance** than ngrok (lower latency)
          - **No authentication required** - Uses temporary tunnel
          - **Secure connection** through Cloudflare's network
          
          ## ‚è≥ Status
          
          The workflow will keep running until:
          - You manually cancel it, or
          - The 6-hour timeout is reached
          
          When you're done, click "Cancel workflow" to stop the job.
          "@
          
          $summary | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Encoding utf8
          
          Write-Host "üìù Job summary generated successfully!" -ForegroundColor Green
      
      - name: Keep Session Alive
        shell: pwsh
        run: |
          Write-Host "‚è≥ Keeping session alive..." -ForegroundColor Cyan
          Write-Host ""
          Write-Host "The tunnel is now active and will remain open until:" -ForegroundColor Yellow
          Write-Host "  - You cancel this workflow, or" -ForegroundColor Yellow
          Write-Host "  - The 6-hour timeout is reached" -ForegroundColor Yellow
          Write-Host ""
          Write-Host "You can connect anytime using the instructions above." -ForegroundColor Green
          Write-Host ""
          
          # Keep the workflow running
          $elapsed = 0
          $maxTime = 21600  # 6 hours in seconds
          $interval = 300   # Update every 5 minutes
          
          while ($elapsed -lt $maxTime) {
            $remaining = $maxTime - $elapsed
            $hours = [math]::Floor($remaining / 3600)
            $minutes = [math]::Floor(($remaining % 3600) / 60)
            Write-Host "‚è∞ Time remaining: $hours hours $minutes minutes" -ForegroundColor Green
            Start-Sleep -Seconds $interval
            $elapsed += $interval
          }
          
          Write-Host ""
          Write-Host "‚úÖ Maximum session time reached!" -ForegroundColor Green
