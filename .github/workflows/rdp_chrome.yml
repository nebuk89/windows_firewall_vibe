name: RDP via Chrome Remote Desktop

on:
  workflow_dispatch:
    inputs:
      authcode:
        description: 'Chrome Remote Desktop command from https://remotedesktop.google.com/headless (Windows CMD command - starts with "%PROGRAMFILES(X86)%")'
        required: true
        type: string
      pincode:
        description: 'Six digit PIN for connection (will be truncated to 6 digits if longer)'
        required: true
        type: string

jobs:
  rdp-chrome:
    runs-on: windows-latest
    timeout-minutes: 360  # 6 hours max
    permissions:
      contents: read

    steps:
      - name: Security Notice
        shell: pwsh
        run: |
          Write-Host "‚ö†Ô∏è  SECURITY NOTICE" -ForegroundColor Red
          Write-Host "This workflow uses Chrome Remote Desktop for access." -ForegroundColor Yellow
          Write-Host "Make sure you trust the Google account you're using." -ForegroundColor Yellow
          Write-Host ""
          Write-Host "‚ÑπÔ∏è  How to get the auth command:" -ForegroundColor Cyan
          Write-Host "1. Go to https://remotedesktop.google.com/headless" -ForegroundColor White
          Write-Host "2. Click 'Begin' and 'Next'" -ForegroundColor White
          Write-Host "3. Authorize and name your computer" -ForegroundColor White
          Write-Host "4. Copy the Windows CMD command shown (starts with '%PROGRAMFILES(X86)%')" -ForegroundColor White
          Write-Host "5. Paste it as the 'authcode' input when running this workflow" -ForegroundColor White
          Write-Host ""
          Write-Host "‚ö†Ô∏è  Important: Use the Windows CMD command, NOT the PowerShell command" -ForegroundColor Yellow
          Write-Host ""

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Disable Windows Firewall
        shell: pwsh
        run: |
          Write-Host "üîß Disabling Windows Firewall for Chrome Remote Desktop..." -ForegroundColor Cyan
          Set-NetFirewallProfile -Profile Domain,Public,Private -Enabled False
          Write-Host "‚úÖ Firewall disabled" -ForegroundColor Green

      - name: Start Chrome Remote Desktop (robust)
        shell: pwsh
        env:
          CRD_AUTH_CODE_INPUT: ${{ github.event.inputs.authcode }}
          CRD_PIN_INPUT: ${{ github.event.inputs.pincode }}
        run: |
          $ErrorActionPreference = 'Stop'
          $auth = $env:CRD_AUTH_CODE_INPUT
          if (-not $auth) { throw "CRD_AUTH_CODE not provided" }

          $pin = $env:CRD_PIN_INPUT
          if (-not $pin) { throw "CRD_PIN not provided" }

          Write-Host "üöÄ Starting Chrome Remote Desktop..." -ForegroundColor Cyan
          $logPath = "$env:TEMP\crd_setup.log"
          ./scripts/start-crd.ps1 -AuthCode $auth -Pin $pin -HostName $env:COMPUTERNAME -LogPath $logPath

      - name: Upload CRD log
        uses: actions/upload-artifact@v4
        with:
          name: crd-setup-log
          path: ${{ runner.temp }}/crd_setup.log
          if-no-files-found: ignore

      - name: Generate Job Summary
        shell: pwsh
        run: |
          $summary = @"
          # üñ•Ô∏è Chrome Remote Desktop Ready

          ## Connection Information

          Your Windows runner is now accessible via Chrome Remote Desktop!

          ## üîå How to Connect

          1. Open [Chrome Remote Desktop](https://remotedesktop.google.com/access)
          2. Sign in with the same Google account you used to generate the auth command
          3. Look for your computer in the **Remote devices** section
          4. Click on it to connect
          5. Enter your 6-digit PIN when prompted
          6. Enjoy full desktop access! üéâ

          ## ‚úÖ Features

          - **No additional software needed** - Works directly in your web browser
          - **Cross-platform** - Access from Windows, Mac, Linux, ChromeOS, or mobile
          - **Full desktop experience** - Complete GUI access to the Windows runner
          - **Secure** - Authenticated through your Google account
          - **No audio support** - Chrome Remote Desktop doesn't support audio streaming

          ## ‚è≥ Status

          The workflow will keep running until:
          - You manually cancel it, or
          - The 6-hour timeout is reached

          When you're done, click "Cancel workflow" to stop the job.

          ## üí° Tip

          Chrome Remote Desktop provides a smoother experience than traditional RDP for web-based access,
          making it perfect for quick debugging sessions or GUI testing.
          "@

          $summary | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Encoding utf8

          Write-Host "üìù Job summary generated successfully!" -ForegroundColor Green

      - name: Append CRD log tail to summary
        shell: pwsh
        run: |
          $logPath = Join-Path $env:TEMP "crd_setup.log"
          if (Test-Path $logPath) {
            $tail = (Get-Content $logPath -Tail 40) -join "`n"
            $snippet = @"
          ## üßæ CRD Setup Log (tail)
          ```
          $tail
          ```
          "@
            $snippet | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append -Encoding utf8
          } else {
            Write-Host "‚ö†Ô∏è CRD log not found at $logPath" -ForegroundColor Yellow
          }

      - name: Keep Session Alive
        shell: pwsh
        run: |
          Write-Host "‚è≥ Keeping session alive..." -ForegroundColor Cyan
          Write-Host ""
          Write-Host "Chrome Remote Desktop is now active and accessible." -ForegroundColor Green
          Write-Host "The session will remain open until you cancel or timeout occurs." -ForegroundColor Yellow
          Write-Host ""

          # Keep the workflow running
          $elapsed = 0
          $maxTime = 21600  # 6 hours in seconds
          $interval = 300   # Update every 5 minutes

          while ($elapsed -lt $maxTime) {
            $remaining = $maxTime - $elapsed
            $hours = [math]::Floor($remaining / 3600)
            $minutes = [math]::Floor(($remaining % 3600) / 60)
            Write-Host "‚è∞ Time remaining: $hours hours $minutes minutes" -ForegroundColor Green
            Start-Sleep -Seconds $interval
            $elapsed += $interval
          }

          Write-Host ""
          Write-Host "‚úÖ Maximum session time reached!" -ForegroundColor Green
